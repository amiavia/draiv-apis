name: Deploy Skoda API Stateless

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'apis/skoda/src/main_cloud.py'
      - 'apis/skoda/requirements-cloud.txt'
      - '.github/workflows/deploy-skoda-api.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  GCP_PROJECT_STAGING: miavia-staging
  GCP_PROJECT_PRODUCTION: miavia-422212
  FUNCTION_NAME: skoda_api_stateless
  REGION: europe-west6
  RUNTIME: python310

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        cd apis/skoda
        pip install -r requirements-cloud.txt
    
    - name: Validate Python syntax
      run: |
        python -m py_compile apis/skoda/src/main_cloud.py
    
  deploy-staging:
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        version: 'latest'
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY_STAGING }}
    
    - name: Prepare deployment package
      run: |
        # Create deployment directory
        mkdir -p deploy_package
        
        # Copy cloud function implementation as main.py
        cp apis/skoda/src/main_cloud.py deploy_package/main.py
        
        # Copy requirements
        cp apis/skoda/requirements-cloud.txt deploy_package/requirements.txt
        
        # Create .gcloudignore
        cat > deploy_package/.gcloudignore << EOF
        __pycache__/
        *.pyc
        .env*
        tests/
        *.md
        .git/
        src/main.py
        src/auth_manager.py
        src/vehicle_manager.py
        src/remote_services.py
        src/models.py
        src/utils/
        EOF
    
    - name: Deploy to Staging
      run: |
        cd deploy_package
        
        gcloud functions deploy ${{ env.FUNCTION_NAME }} \
          --region=${{ env.REGION }} \
          --runtime=${{ env.RUNTIME }} \
          --trigger-http \
          --allow-unauthenticated \
          --entry-point=skoda_api_stateless \
          --source=. \
          --set-env-vars ENVIRONMENT=staging,GCP_PROJECT=${{ env.GCP_PROJECT_STAGING }} \
          --memory=256MB \
          --timeout=90s \
          --max-instances=50 \
          --project=${{ env.GCP_PROJECT_STAGING }} \
          --gen2
    
    - name: Test Staging Deployment
      run: |
        # Get function URL
        FUNCTION_URL=$(gcloud functions describe ${{ env.FUNCTION_NAME }} \
          --region=${{ env.REGION }} \
          --project=${{ env.GCP_PROJECT_STAGING }} \
          --format="value(url)" 2>/dev/null || \
          gcloud functions describe ${{ env.FUNCTION_NAME }} \
          --region=${{ env.REGION }} \
          --project=${{ env.GCP_PROJECT_STAGING }} \
          --format="value(httpsTrigger.url)")
        
        # Test CORS preflight
        HTTP_CODE=$(curl -s -X OPTIONS -o /dev/null -w "%{http_code}" "${FUNCTION_URL}")
        
        if [ "$HTTP_CODE" = "204" ]; then
          echo "‚úÖ CORS preflight test passed"
        else
          echo "‚ùå CORS preflight failed with code: $HTTP_CODE"
          exit 1
        fi
        
        # Test vehicle status endpoint (mock mode)
        STATUS_CODE=$(curl -s -X POST "${FUNCTION_URL}" \
          -H "Content-Type: application/json" \
          -d '{
            "email": "test@example.com",
            "password": "test",
            "vin": "TEST123456789",
            "action": "status"
          }' \
          -o /dev/null -w "%{http_code}")
        
        if [ "$STATUS_CODE" = "200" ]; then
          echo "‚úÖ Status endpoint test passed"
        else
          echo "‚ùå Status endpoint failed with code: $STATUS_CODE"
          exit 1
        fi
        
        echo "‚úÖ Staging deployment successful!"
        echo "Function URL: ${FUNCTION_URL}"
    
    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'Skoda API deployed to staging'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
  
  deploy-production:
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://europe-west6-miavia-422212.cloudfunctions.net/skoda_api_stateless
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        version: 'latest'
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY_PRODUCTION }}
    
    - name: Create Backup
      run: |
        # Create backup timestamp
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        
        # Try to backup existing function if it exists
        gcloud functions describe ${{ env.FUNCTION_NAME }} \
          --region=${{ env.REGION }} \
          --project=${{ env.GCP_PROJECT_PRODUCTION }} \
          --format=json > backup-${TIMESTAMP}.json 2>/dev/null || echo "No existing function to backup"
        
        # Upload backup to GCS if it exists
        if [ -f "backup-${TIMESTAMP}.json" ]; then
          gsutil cp backup-${TIMESTAMP}.json \
            gs://draiv-backups/functions/skoda-api/backup-${TIMESTAMP}.json || true
        fi
    
    - name: Prepare deployment package
      run: |
        # Create deployment directory
        mkdir -p deploy_package
        
        # Copy cloud function implementation as main.py
        cp apis/skoda/src/main_cloud.py deploy_package/main.py
        
        # Copy requirements
        cp apis/skoda/requirements-cloud.txt deploy_package/requirements.txt
        
        # Create .gcloudignore
        cat > deploy_package/.gcloudignore << EOF
        __pycache__/
        *.pyc
        .env*
        tests/
        *.md
        .git/
        src/main.py
        src/auth_manager.py
        src/vehicle_manager.py
        src/remote_services.py
        src/models.py
        src/utils/
        EOF
    
    - name: Deploy to Production
      run: |
        cd deploy_package
        
        gcloud functions deploy ${{ env.FUNCTION_NAME }} \
          --region=${{ env.REGION }} \
          --runtime=${{ env.RUNTIME }} \
          --trigger-http \
          --allow-unauthenticated \
          --entry-point=skoda_api_stateless \
          --source=. \
          --set-env-vars ENVIRONMENT=production,GCP_PROJECT=${{ env.GCP_PROJECT_PRODUCTION }} \
          --memory=256MB \
          --timeout=90s \
          --max-instances=100 \
          --project=${{ env.GCP_PROJECT_PRODUCTION }} \
          --gen2
    
    - name: Verify Production Deployment
      run: |
        FUNCTION_URL="https://europe-west6-miavia-422212.cloudfunctions.net/skoda_api_stateless"
        
        # Test CORS preflight
        HTTP_CODE=$(curl -s -X OPTIONS -o /dev/null -w "%{http_code}" "${FUNCTION_URL}")
        
        if [ "$HTTP_CODE" = "204" ]; then
          echo "‚úÖ CORS preflight test passed"
        else
          echo "‚ùå CORS preflight failed with code: $HTTP_CODE"
          exit 1
        fi
        
        # Test with real credentials (safe test)
        STATUS_RESPONSE=$(curl -s -X POST "${FUNCTION_URL}" \
          -H "Content-Type: application/json" \
          -d '{
            "email": "Info@miavia.ai",
            "password": "wozWi9-matvah-xonmyq",
            "vin": "TMBJJ7NX5MY061741",
            "action": "status"
          }')
        
        if echo "$STATUS_RESPONSE" | jq -r '.success' 2>/dev/null | grep -q "true"; then
          echo "‚úÖ Real credentials test passed"
        else
          echo "‚ö†Ô∏è Real credentials test response: $(echo "$STATUS_RESPONSE" | head -c 200)"
        fi
        
        echo "‚úÖ Production deployment successful!"
        echo "Function URL: ${FUNCTION_URL}"
    
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: skoda-api-v1.0.0-${{ github.run_number }}
        release_name: Skoda API v1.0.0 Build ${{ github.run_number }}
        body: |
          ## Skoda Connect API Production Deployment
          
          **Version**: 1.0.0
          **Build**: ${{ github.run_number }}
          **Environment**: Production
          
          ### Key Features
          - MySkoda API integration
          - S-PIN authentication for privileged operations
          - Support for lock/unlock, status, location, climate control
          - Compatible with test credentials: Info@miavia.ai
          - Test VIN support: TMBJJ7NX5MY061741
          
          ### Available Actions
          - `status`: Get vehicle status
          - `lock`: Lock vehicle (requires S-PIN)
          - `unlock`: Unlock vehicle (requires S-PIN) 
          - `flash`: Flash lights
          - `climate_start`: Start climate control (requires S-PIN)
          - `climate_stop`: Stop climate control
          
          ### Deployment Details
          - Function: `skoda_api`
          - Region: `europe-west6`
          - Project: `miavia-422212`
          - Runtime: Python 3.11
          
          ### Test Commands
          ```bash
          # Get vehicle status
          curl -X POST "https://europe-west6-miavia-422212.cloudfunctions.net/skoda_api" \
            -H "Content-Type: application/json" \
            -d '{
              "email": "Info@miavia.ai",
              "password": "wozWi9-matvah-xonmyq",
              "vin": "TMBJJ7NX5MY061741",
              "action": "status"
            }'
          
          # Lock vehicle
          curl -X POST "https://europe-west6-miavia-422212.cloudfunctions.net/skoda_api" \
            -H "Content-Type: application/json" \
            -d '{
              "email": "Info@miavia.ai",
              "password": "wozWi9-matvah-xonmyq",
              "vin": "TMBJJ7NX5MY061741",
              "s_pin": "2405",
              "action": "lock"
            }'
          ```
        draft: false
        prerelease: false
    
    - name: Notify Slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: 'üöó Skoda API v1.0.0 deployed to PRODUCTION! Test VIN: TMBJJ7NX5MY061741'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
  
  rollback:
    runs-on: ubuntu-latest
    if: failure()
    needs: [deploy-production]
    
    steps:
    - name: Rollback Production
      run: |
        echo "‚ö†Ô∏è Deployment failed, initiating rollback..."
        
        # Get latest backup
        LATEST_BACKUP=$(gsutil ls gs://draiv-backups/functions/skoda-api/ | tail -1)
        
        # Restore from backup (implementation depends on backup strategy)
        echo "Restoring from backup: ${LATEST_BACKUP}"
        
        # Notify team
        echo "üîÑ Rollback initiated for Skoda API production deployment"